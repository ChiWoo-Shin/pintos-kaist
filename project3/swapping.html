
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Swap In/Out Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="cow.html" />
    
    
    <link rel="prev" href="memory_mapped_files.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Introduction</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../introduction/getting_started.html">
            
                <a href="../introduction/getting_started.html">
            
                    
                    Getting Started
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../introduction/grading.html">
            
                <a href="../introduction/grading.html">
            
                    
                    Grading
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../introduction/legal_and_ethical_issues.html">
            
                <a href="../introduction/legal_and_ethical_issues.html">
            
                    
                    Legal and Ethical Issues
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Project1: Threads</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../project1/introduction.html">
            
                <a href="../project1/introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../project1/alarm_clock.html">
            
                <a href="../project1/alarm_clock.html">
            
                    
                    Alarm Clock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../project1/priority_scheduling.html">
            
                <a href="../project1/priority_scheduling.html">
            
                    
                    Priority Scheduling
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../project1/advanced_scheduler.html">
            
                <a href="../project1/advanced_scheduler.html">
            
                    
                    Advanced Scheduler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../project1/FAQ.html">
            
                <a href="../project1/FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Project2: User Programs</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../project2/introduction.html">
            
                <a href="../project2/introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../project2/argument_passing.html">
            
                <a href="../project2/argument_passing.html">
            
                    
                    Argument Passing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../project2/user_memory.html">
            
                <a href="../project2/user_memory.html">
            
                    
                    User Memory
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="../project2/system_call.html">
            
                <a href="../project2/system_call.html">
            
                    
                    System Calls
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="../project2/process_termination.html">
            
                <a href="../project2/process_termination.html">
            
                    
                    Process Termination Messages
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="../project2/deny_write.html">
            
                <a href="../project2/deny_write.html">
            
                    
                    Denying Writes to Executables
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.7" data-path="../project2/dup.html">
            
                <a href="../project2/dup.html">
            
                    
                    Extend File Descriptor (Extra)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.8" data-path="../project2/FAQ.html">
            
                <a href="../project2/FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Project3: Virtual Memory</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="introduction.html">
            
                <a href="introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="vm_management.html">
            
                <a href="vm_management.html">
            
                    
                    Memory Management
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="anon.html">
            
                <a href="anon.html">
            
                    
                    Anonymous Page
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="stack_growth.html">
            
                <a href="stack_growth.html">
            
                    
                    Stack Growth
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="memory_mapped_files.html">
            
                <a href="memory_mapped_files.html">
            
                    
                    Memory Mapped Files
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="4.6" data-path="swapping.html">
            
                <a href="swapping.html">
            
                    
                    Swap In/Out
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="cow.html">
            
                <a href="cow.html">
            
                    
                    Copy-on-Write (Extra)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.8" data-path="FAQ.html">
            
                <a href="FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Project4: File System</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../project4/introduction.html">
            
                <a href="../project4/introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../project4/indexed_and_extensible_files.html">
            
                <a href="../project4/indexed_and_extensible_files.html">
            
                    
                    Indexed and Extensible Files
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="../project4/subdirectories.html">
            
                <a href="../project4/subdirectories.html">
            
                    
                    Subdirectories and Soft Links
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="../project4/buffer_cache.html">
            
                <a href="../project4/buffer_cache.html">
            
                    
                    Buffer Cache (Extra)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="../project4/synchronization.html">
            
                <a href="../project4/synchronization.html">
            
                    
                    Synchronization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.6" data-path="../project4/FAQ.html">
            
                <a href="../project4/FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Appendix</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../appendix/threads.html">
            
                <a href="../appendix/threads.html">
            
                    
                    Threads
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="../appendix/synchronization.html">
            
                <a href="../appendix/synchronization.html">
            
                    
                    Synchronization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="../appendix/memory_allocation.html">
            
                <a href="../appendix/memory_allocation.html">
            
                    
                    Memory Allocation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.4" data-path="../appendix/virtual_address.html">
            
                <a href="../appendix/virtual_address.html">
            
                    
                    Virtual Address
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.5" data-path="../appendix/page_table.html">
            
                <a href="../appendix/page_table.html">
            
                    
                    Page Table
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.6" data-path="../appendix/debugging_tools.html">
            
                <a href="../appendix/debugging_tools.html">
            
                    
                    Debugging Tools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.7" data-path="../appendix/development_tools.html">
            
                <a href="../appendix/development_tools.html">
            
                    
                    Development Tools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.8" data-path="../appendix/hash_table.html">
            
                <a href="../appendix/hash_table.html">
            
                    
                    Hash Table
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Swap In/Out</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="swap-inout">Swap In/Out</h2>
<p>Memory swapping is a memory reclamation technique to maximize the usage of
physical memory. When frames of the main memory is allocated, the system cannot
handle any more memory allocation requests from user programs. One solution is
to swap out memory frames that are not being currently used to disk. This frees
some memory resources and makes available to other applications.</p>
<p>Swapping is done by the operating system. When the system detects that it has
run out of memory but receives a memory allocation request, it chooses a page to
evict out to swap disk. Then, the exact state of the memory frame is copied to
the disk. When a process tries to access a swapped out page, OS recovers the
page by bringing the exact content back to the memory.</p>
<p>The page chosen for eviction may be an anonymous page or a file-backed page.
In this section, you will handle each case.</p>
<p>All the swapping operations are not called explicitly, but as function pointers.
They are members of <code>struct page_operations file_ops</code>, which will be registered
as operations for each page&apos;s initializer.</p>
<h3 id="anonymous-page">Anonymous Page</h3>
<p><strong>Modify <code>vm_anon_init</code> and <code>anon_initializer</code> in <code>vm/anon.c</code>.</strong> Anonymous page
doesn&apos;t have any backing storage for it. To support the swapping of anonymous
page, we provide the temporal backing storage called swap disk. You will utilize
the swap disk to implement the swap for anonymous pages.</p>
<hr>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">vm_anon_init</span> <span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;
</code></pre>
<blockquote>
<p>In this function, you need to set up the swap disk. You will also need a data
structure to manage free and used areas in the swap disk. The swap area will
be also managed at the granularity of PGSIZE (4096 bytes)</p>
</blockquote>
<hr>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">anon_initializer</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-keyword">enum</span> vm_type type, <span class="hljs-keyword">void</span> *kva)</span></span>;
</code></pre>
<blockquote>
<p>This is the initializer for the anonymous page. You will need to add some
information to the <code>anon_page</code> to support the swapping.</p>
</blockquote>
<p>Now, implement <code>anon_swap_in</code> and <code>anon_swap_out</code> in <code>vm/anon.c</code> to support
swapping for anonymous pages. Since a page needs to swapped out to be swapped
in, you may want to implement <code>anon_swap_out</code> before implementing
<code>anon_swap_in</code>. You need to move the data contents to the swap disk, and bring
it back to memory safely.</p>
<hr>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">anon_swap_in</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-keyword">void</span> *kva)</span></span>;
</code></pre>
<blockquote>
<p>Swaps in an anonymous page from the swap disk by reading the data contents
from the disk to memory. The location of the data is the swap disk should have
been saved in the page struct when the page was swapped out. Remember to
update the swap table (See <a href="introduction.html">Managing the Swap Table</a>).</p>
</blockquote>
<hr>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">anon_swap_out</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page)</span></span>;
</code></pre>
<blockquote>
<p>Swaps out an anonymous page to the swap disk by copying the contents
from the memory to the disk. First, find a free swap slot in the disk using
the swap table, then copy the page of data into the slot. The location of the
data should be saved in the page struct. If there is no more free slot in the
disk, you can panic the kernel.</p>
</blockquote>
<h3 id="file-mapped-page">File-Mapped Page</h3>
<p>Since the contents of a file-backed page comes from a file, the mmaped file
should be used as a backing store. That is, evicting a file-backed page writes
it back to the file it was mapped from. Implement <code>file_backed_swap_in</code>,
<code>file_backed_swap_out</code> in <code>vm/file.c</code>. You might modify <code>file_backed_init</code> and
<code>file_initializer</code> according to your design.</p>
<hr>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">file_backed_swap_in</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-keyword">void</span> *kva)</span></span>;
</code></pre>
<blockquote>
<p>Swaps in a page at <code>kva</code> by reading the contents in from the file. You need to
synchronize with the file system.</p>
</blockquote>
<hr>
<pre><code class="lang-C"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">file_backed_swap_out</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page)</span></span>;
</code></pre>
<blockquote>
<p>Swaps out a page by writing the contents back to the file. You may want to
first check if the page is dirty. If it is not dirty, you do not have to
modify the contents in the file. After you swap out the page, remember to turn
off the dirty bit for the page.</p>
</blockquote>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="memory_mapped_files.html" class="navigation navigation-prev " aria-label="Previous page: Memory Mapped Files">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="cow.html" class="navigation navigation-next " aria-label="Next page: Copy-on-Write (Extra)">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Swap In/Out","level":"4.6","depth":1,"next":{"title":"Copy-on-Write (Extra)","level":"4.7","depth":1,"path":"project3/cow.md","ref":"project3/cow.md","articles":[]},"previous":{"title":"Memory Mapped Files","level":"4.5","depth":1,"path":"project3/memory_mapped_files.md","ref":"project3/memory_mapped_files.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"project3/swapping.md","mtime":"2022-05-23T14:07:34.304Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-05-23T14:13:22.147Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

