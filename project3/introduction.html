
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Introduction Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="vm_management.html" />
    
    
    <link rel="prev" href="../project2/FAQ.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Introduction</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../introduction/getting_started.html">
            
                <a href="../introduction/getting_started.html">
            
                    
                    Getting Started
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../introduction/grading.html">
            
                <a href="../introduction/grading.html">
            
                    
                    Grading
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../introduction/legal_and_ethical_issues.html">
            
                <a href="../introduction/legal_and_ethical_issues.html">
            
                    
                    Legal and Ethical Issues
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Project1: Threads</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../project1/introduction.html">
            
                <a href="../project1/introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../project1/alarm_clock.html">
            
                <a href="../project1/alarm_clock.html">
            
                    
                    Alarm Clock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../project1/priority_scheduling.html">
            
                <a href="../project1/priority_scheduling.html">
            
                    
                    Priority Scheduling
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../project1/advanced_scheduler.html">
            
                <a href="../project1/advanced_scheduler.html">
            
                    
                    Advanced Scheduler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../project1/FAQ.html">
            
                <a href="../project1/FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Project2: User Programs</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../project2/introduction.html">
            
                <a href="../project2/introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../project2/argument_passing.html">
            
                <a href="../project2/argument_passing.html">
            
                    
                    Argument Passing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../project2/user_memory.html">
            
                <a href="../project2/user_memory.html">
            
                    
                    User Memory
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="../project2/system_call.html">
            
                <a href="../project2/system_call.html">
            
                    
                    System Calls
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="../project2/process_termination.html">
            
                <a href="../project2/process_termination.html">
            
                    
                    Process Termination Messages
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="../project2/deny_write.html">
            
                <a href="../project2/deny_write.html">
            
                    
                    Denying Writes to Executables
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.7" data-path="../project2/dup.html">
            
                <a href="../project2/dup.html">
            
                    
                    Extend File Descriptor (Extra)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.8" data-path="../project2/FAQ.html">
            
                <a href="../project2/FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Project3: Virtual Memory</li>
        
        
    
        <li class="chapter active" data-level="4.1" data-path="introduction.html">
            
                <a href="introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="vm_management.html">
            
                <a href="vm_management.html">
            
                    
                    Memory Management
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="anon.html">
            
                <a href="anon.html">
            
                    
                    Anonymous Page
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="stack_growth.html">
            
                <a href="stack_growth.html">
            
                    
                    Stack Growth
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="memory_mapped_files.html">
            
                <a href="memory_mapped_files.html">
            
                    
                    Memory Mapped Files
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="swapping.html">
            
                <a href="swapping.html">
            
                    
                    Swap In/Out
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="cow.html">
            
                <a href="cow.html">
            
                    
                    Copy-on-Write (Extra)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.8" data-path="FAQ.html">
            
                <a href="FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Project4: File System</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../project4/introduction.html">
            
                <a href="../project4/introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../project4/indexed_and_extensible_files.html">
            
                <a href="../project4/indexed_and_extensible_files.html">
            
                    
                    Indexed and Extensible Files
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="../project4/subdirectories.html">
            
                <a href="../project4/subdirectories.html">
            
                    
                    Subdirectories and Soft Links
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="../project4/buffer_cache.html">
            
                <a href="../project4/buffer_cache.html">
            
                    
                    Buffer Cache (Extra)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="../project4/synchronization.html">
            
                <a href="../project4/synchronization.html">
            
                    
                    Synchronization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.6" data-path="../project4/FAQ.html">
            
                <a href="../project4/FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Appendix</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../appendix/threads.html">
            
                <a href="../appendix/threads.html">
            
                    
                    Threads
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="../appendix/synchronization.html">
            
                <a href="../appendix/synchronization.html">
            
                    
                    Synchronization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="../appendix/memory_allocation.html">
            
                <a href="../appendix/memory_allocation.html">
            
                    
                    Memory Allocation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.4" data-path="../appendix/virtual_address.html">
            
                <a href="../appendix/virtual_address.html">
            
                    
                    Virtual Address
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.5" data-path="../appendix/page_table.html">
            
                <a href="../appendix/page_table.html">
            
                    
                    Page Table
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.6" data-path="../appendix/debugging_tools.html">
            
                <a href="../appendix/debugging_tools.html">
            
                    
                    Debugging Tools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.7" data-path="../appendix/development_tools.html">
            
                <a href="../appendix/development_tools.html">
            
                    
                    Development Tools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.8" data-path="../appendix/hash_table.html">
            
                <a href="../appendix/hash_table.html">
            
                    
                    Hash Table
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Introduction</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="project3-virtual-memory">Project3: Virtual Memory</h1>
<p>By now you should have some familiarity with the inner workings of Pintos. Your
OS can properly handle multiple threads of execution with proper
synchronization, and can load multiple user programs at once. However, the
number and size of programs that can run is limited by the machine&apos;s main memory
size. In this assignment, you will remove that limitation by building an
illusion of infinite memory.</p>
<p>You will build this assignment on top of the last one. Test programs from
project 2 should also work with project 3. You should take care to fix any bugs
in your project 2 submission before you start work on project 3, because those
bugs will most likely cause the same problems in project 3.</p>
<p>For the project 3, we make step-by-step directions for your ease.</p>
<h2 id="background">Background</h2>
<h3 id="source-files">Source Files</h3>
<p>You will work in the <code>vm</code> directory for this project. The <code>Makefile</code> is updated
to turn on the setting <code>-DVM</code>. We provide an enormous amount of template code.
<strong><em>You MUST follow the given template. That is, if you submit the code, that
is not based on the given template, you get 0pts.</em></strong> Also, you should
never change the template where it is marked &quot;DO NOT CHANGE&quot;. Here, we
provide some details about each template file that you will be modifying.</p>
<ul>
<li><p><code>include/vm/vm.h</code>, <code>vm/vm.c</code></p>
<p>Provides a general interface for virtual memory. In the header file,
you can see the defintion and explanation for different vm_type -- VM_UNINIT,
VM_ANON, VM_FILE, VM_PAGE_CACHE -- that your virtual memory system has to support (ignore VM_PAGE_CACHE for now, this is for project 4).
You will also implement your supplementary page table here (read below).</p>
</li>
<li><p><code>include/vm/uninit.h</code>, <code>vm/uninit.c</code></p>
<p>Provides operations for uninitialized pages (vm_type = <code>VM_UNINIT</code>). Under
the current design, all pages are initially set up as uninitialized pages,
then it transforms to anonymous pages or file-backed pages.</p>
</li>
<li><p><code>include/vm/anon.h</code>, <code>vm/anon.c</code></p>
<p>Provides operations for anonymous pages (vm_type = <code>VM_ANON</code>).</p>
</li>
<li><p><code>include/vm/file.h</code>, <code>vm/file.c</code></p>
<p>Provides operations for file-backed pages (vm_type = <code>VM_FILE</code>).</p>
</li>
<li><p><code>include/vm/inspect.h</code>, <code>vm/inspect.c</code></p>
<p>Contains memory inspection operations for grading. Do not change this files.</p>
</li>
</ul>
<p>Most of the code you write for this project will be files
in <code>vm</code> directory and in files introduced in earlier projects.
You will probably be encountering just a few files for the first time such as:</p>
<ul>
<li><p><code>include/devices/block.h</code>, <code>devices/block.c</code></p>
<p>Provides sector-based read and write access to block device. You will use this
interface to access the swap partition as a block device.</p>
</li>
</ul>
<h3 id="memory-terminology">Memory Terminology</h3>
<p>We begin by presenting some terminology for memory and storage.
Some of these terms should be familiar from project 2 (see
<a href="../project2/introduction.html">Virtual Memory Layout</a>), but much of it is new.</p>
<h4 id="pages">Pages</h4>
<p>A page, sometimes called a virtual page, is a continuous region of virtual
memory of size 4,096 bytes (the <strong><em>page size</em></strong>) in length. A page must be
<strong><em>page-aligned</em></strong>, that is, start on a virtual address evenly divisible by the
page size. Thus, the last 12 bits of a 64-bit virtual address is the
<strong><em>page offset</em></strong> (or just <strong><em>offset</em></strong>). The upper bits are used to indicate
the index in the page table, which will be introduced soon. With 64-bit system,
we use 4-level page table, which makes a virtual address to look like this:</p>
<pre><code>63          48 47            39 38            30 29            21 20         12 11         0
+-------------+----------------+----------------+----------------+-------------+------------+
| Sign Extend |    Page-Map    | Page-Directory | Page-directory |  Page-Table |    Page    |
|             | Level-4 Offset |    Pointer     |     Offset     |   Offset    |   Offset   |
+-------------+----------------+----------------+----------------+-------------+------------+
              |                |                |                |             |            |
              +------- 9 ------+------- 9 ------+------- 9 ------+----- 9 -----+---- 12 ----+
                                          Virtual Address
</code></pre><p>Each process has an independent set of user (virtual) pages, which are those
pages below the virtual address <code>KERN_BASE</code> (0x8004000000). The set of
<strong><em>kernel (virtual) pages</em></strong>, on the other hand, is global, and thus remain in
the same position
regardless of what thread or process is running. The kernel may access both user
and kernel pages, but a user process may access only its own user pages. See
<a href="../project2/introduction.html">Virtual Memory Layout</a>, for more information.</p>
<p>Pintos provides several useful functions for working with virtual addresses.
See Section <a href="../appendix/virtual_address.html">Virtual Addresses</a>, for details.</p>
<h4 id="frames">Frames</h4>
<p>A <strong><em>frame</em></strong>, sometimes called a <strong><em>physical frame</em></strong> or a <strong><em>page frame</em></strong>, is
a continuous region of physical memory. Like pages, frames must be page-size and
page-aligned. Thus, a 64-bit physical address can be divided into a
<strong><em>frame number</em></strong> and a frame <strong><em>offset</em></strong> (or just <strong><em>offset</em></strong>), like this:</p>
<pre><code>                          12 11         0
    +-----------------------+-----------+
    |      Frame Number     |   Offset  |
    +-----------------------+-----------+
              Physical Address
</code></pre><p>x86-64 doesn&apos;t provide any way to directly access memory at a physical
address. Pintos works around this by mapping kernel virtual memory directly to
physical memory - the first page of kernel virtual memory is mapped to the first
frame of physical memory, the second page to the second frame, and so on. Thus,
frames can be accessed through kernel virtual memory.</p>
<p>Pintos provides functions for translating between physical addresses and kernel
virtual addresses. See <a href="../appendix/virtual_address.html">Virtual Addresses</a> for
details.</p>
<h4 id="page-tables">Page Tables</h4>
<p>A <strong><em>page table</em></strong> is a data structure that the CPU uses to translate a virtual
address to a physical address, that is, from a page to a frame. The page table
format is dictated by the x86-64 architecture. Pintos provides page table
management code in <code>threads/mmu.c</code>.</p>
<p>The diagram below illustrates the relationship between pages and frames. The
virtual address, on the left, consists of a page number and an offset. The page
table translates the page number into a frame number, which is combined with the
unmodified offset to obtain the physical address, on the right.</p>
<pre><code>                          +----------+
         .---------------&gt;|Page Table|-----------.
        /                 +----------+            |
        |   12 11 0                               V  12 11 0
    +---------+----+                         +---------+----+
    | Page Nr | Ofs|                         |Frame Nr | Ofs|
    +---------+----+                         +---------+----+
     Virt Addr   |                            Phys Addr    ^
                  \_______________________________________/
</code></pre><h4 id="swap-slots">Swap Slots</h4>
<p>A <strong><em>swap slot</em></strong> is a page-size region of disk space in the swap
partition. Although hardware limitations dictating the placement
of slots are more flexible than for frames, swap slots should be
page-aligned because there is no downside in doing so.</p>
<h3 id="resource-management-overview">Resource Management Overview</h3>
<p>You will need to design/implement the following data structures:</p>
<p><strong><em>Supplemental page table</em></strong></p>
<blockquote>
<p>Enables page fault handling by supplementing the page table.
See Managing the Supplemental Page Table below.</p>
</blockquote>
<p><strong><em>Frame table</em></strong></p>
<blockquote>
<p>Allows efficient implementation of eviction policy of physical frames
See Managing the Frame Table below.</p>
</blockquote>
<p><strong><em>Swap table</em></strong></p>
<blockquote>
<p>Tracks usage of swap slots. See Managing the Swap Table below.</p>
</blockquote>
<p>You do not necessarily need to implement three completely distinct data
structures: it may be convenient to wholly or partially merge related resources
into a unified data structure.</p>
<p>For each data structure, you need to determine what information each element
should contain. You also need to decide on the data structure&apos;s scope, either
local (per-process) or global (applying to the whole system), and how many
instances are required within its scope.</p>
<p>To simplify your design, you may store these data structures in non-pageable
memory (e.g., memory allocated by <code>calloc</code> or <code>malloc</code>). That means that you can be sure that pointers among them will remain valid.</p>
<h4 id="choices-of-implementation-performance-perspective">Choices of implementation (Performance perspective)</h4>
<p>Possible choices for implementation include arrays, lists, bitmaps, and hash
tables. An array is often the simplest approach, but a sparsely populated array
wastes memory. Lists are also simple, but traversing a long list to find
a particular position wastes time. Both arrays and lists can be resized, but lists
more efficiently support insertion and deletion in the middle.</p>
<p>Pintos includes a bitmap data structure in <code>lib/kernel/bitmap.c</code> and
<code>include/lib/kernel/bitmap.h</code>. A bitmap is an array of bits, each of which can be true
or false. Bitmaps are typically used to track usage in a set of (identical)
resources: if resource n is in use, then bit <strong><em>n</em></strong> of the bitmap is true.
Pintos bitmaps are fixed in size, although you could extend their implementation
to support resizing.</p>
<p>Pintos also includes a hash table data structure (See
<a href="../appendix/hash_table.html">Hash Table</a>). Pintos hash tables efficiently support
insertions and deletions over a wide range of table sizes.</p>
<p>Although more complex data structures may yield better performance or other benefits,
they may also needlessly complicate your implementation. Thus, we do not
recommend implementing any advanced data structure (e.g. a balanced binary tree)
as part of your design.</p>
<h3 id="managing-the-supplemental-page-table">Managing the Supplemental Page Table</h3>
<p>The <strong><em>supplemental</em></strong> page table supplements the page table with additional
data about each page. It is needed because of the limitations imposed by the
page table&apos;s format. Such a data structure is often called a &quot;page table&quot; also;
we add the word &quot;supplemental&quot; to reduce confusion.</p>
<p>The supplemental page table is used for at least two purposes. Most importantly,
on a page fault, the kernel looks up the virtual page that faulted in the
supplemental page table to find out what data should be there. Second, the
kernel consults the supplemental page table when a process terminates, to decide
what resources to free.</p>
<h4 id="organization-of-supplemental-page-table">Organization of Supplemental Page Table</h4>
<p>You may organize the supplemental page table as you wish. There are at least two
basic approaches to its organization: in terms of segments or in terms of pages.
A segment here refers to a consecutive group of pages, i.e., memory region
containing an executable or a memory-mapped file.</p>
<p>Optionally, you may use the page table itself to track the members
of the supplemental page table. You will have to modify the Pintos page table
implementation in <code>threads/mmu.c</code> to do so. We recommend this approach for
advanced students only.</p>
<h4 id="handling-page-fault">Handling page fault</h4>
<p>The most important user of the supplemental page table is the page fault
handler. In project 2, a page fault always indicated a bug in the kernel or a
user program. In project 3, this is no longer true. Now, a page fault might only
indicate that the page must be brought in from a file or swap slot. You will have to
implement a more sophisticated page fault handler to handle these cases. The
page fault handler, which is <code>page_fault()</code> in <code>userprog/exception.c</code>, calls
your page fault handler, <code>vm_try_handle_fault()</code> in <code>vm/vm.c</code>.
Your page fault handler needs to do roughly the following:</p>
<ol>
<li><p>Locate the page that faulted in the supplemental page table. If the memory
reference is valid, use the supplemental page table entry to locate the data
that goes in the page, which might be in the file system, or in a swap slot, or
it might simply be an all-zero page. If you implement sharing (i.e., Copy-on-Write), the page&apos;s data
might even already be in a page frame, but not in the page table.
If the supplemental page table indicates that the user process should not
expect any data at the address it was trying to access, or if the page lies
within kernel virtual memory, or if the access is an attempt to write to a
read-only page, then the access is invalid. Any invalid access terminates the
process and thereby frees all of its resources.</p>
</li>
<li><p>Obtain a frame to store the page. If you implement sharing, the data you need
may already be in a frame, in which case you must be able to locate that frame.</p>
</li>
<li><p>Fetch the data into the frame, by reading it from the file system or swap,
zeroing it, etc. If you implement sharing, the page you need may already be in a
frame, in which case no action is necessary in this step.</p>
</li>
<li><p>Point the page table entry for the faulting virtual address to the physical
page. You can use the functions in <code>threads/mmu.c</code>.</p>
</li>
</ol>
<h3 id="managing-the-frame-table">Managing the Frame Table</h3>
<p>The frame table contains one entry for each frame.
Each entry in the frame table contains a pointer to the page, if any, that
currently occupies it, and other data of your choice. The frame table allows
Pintos to efficiently implement an eviction policy, by choosing a page to evict
when no frames are free.</p>
<p>The frames used for user pages should be obtained from the &quot;user pool,&quot; by
calling <code>palloc_get_page(PAL_USER)</code>. You must use <code>PAL_USER</code> to avoid allocating
from the &quot;kernel pool,&quot; which could cause some test cases to fail unexpectedly.
If you modify <code>palloc.c</code> as part of your frame table implementation, be sure to
retain the distinction between the two pools.</p>
<p>The most important operation on the frame table is obtaining an unused frame.
This is easy when a frame is free. When none is free, a frame must be made free
by evicting some page from its frame.</p>
<p>If no frame can be evicted without allocating a swap slot, but swap is full,
panic the kernel. Real OSes apply a wide range of policies to recover from or
prevent such situations, but these policies are beyond the scope of this
project.</p>
<p>The process of eviction comprises roughly the following steps:</p>
<ol>
<li><p>Choose a frame to evict, using your page replacement algorithm. The
&quot;accessed&quot; and &quot;dirty&quot; bits in the page table, described below, will come in
handy.</p>
</li>
<li><p>Remove references to the frame from any page table that refers to it. Unless
you have implemented sharing, only a single page should refer to a frame at any
given time.</p>
</li>
<li><p>If necessary, write the page to the file system or to swap. The evicted frame
may then be used to store a different page.</p>
</li>
</ol>
<h4 id="accessed-and-dirty-bits">Accessed and Dirty Bits</h4>
<p>x86-64 hardware provides some assistance for implementing page replacement
algorithms, through a pair of bits in the page table entry (PTE) for each page.
On any read or write to a page, the CPU sets the accessed bit to 1 in the page&apos;s
PTE, and on any write, the CPU sets the <strong><em>dirty bit</em></strong> to 1. The CPU never
resets these bits to 0, but the OS may do so.</p>
<p>You need to be aware of <code>aliases</code>, that is, two (or more) pages that refer to
the same frame. When an aliased frame is accessed, the accessed and dirty bits
are updated in only one page table entry (the one for the page used for access).
The accessed and dirty bits for the other aliases are not updated.</p>
<p>In Pintos, every user virtual page is aliased to its kernel virtual page. You
must manage these aliases somehow. For example, your code could check and update
the accessed and dirty bits for both addresses. Alternatively, the kernel could
avoid the problem by only accessing user data through the user virtual address.</p>
<p>Other aliases should only arise if you implement sharing or if
there is a bug in your code.</p>
<p>See Section <a href="../appendix/page_table.html">Page Table Accessed and Dirty Bits</a> for
details of the functions to work with accessed and dirty bits.</p>
<h3 id="managing-the-swap-table">Managing the Swap Table</h3>
<p>The swap table tracks in-use and free swap slots. It should allow picking an
unused swap slot for evicting a page from its frame to the swap partition. It
should allow freeing a swap slot when its page is read back or the process whose
page was swapped is terminated.</p>
<p>From the
<code>vm/build</code> directory, use the command <code>pintos-mkdisk swap.dsk --swap-size=n</code> to
create a disk named <code>swap.dsk</code> that contains a n-MB swap partition. Afterward,
<code>swap.dsk</code> will automatically be attached as an extra disk when you run pintos.
Alternatively, you can tell pintos to use a temporary n-MB swap disk for a
single run with <code>--swap-size=n</code>.</p>
<p>Swap slots should be allocated lazily, that is, only when they are actually
required by eviction. Reading data pages from the executable and writing them to
swap immediately at process startup is not lazy. Swap slots should not be
reserved to store particular pages.</p>
<p>Free a swap slot when its contents are read back into a frame.</p>
<h3 id="managing-memory-mapped-files">Managing Memory Mapped Files</h3>
<p>The file system is most commonly accessed with <code>read</code> and <code>write</code> system calls.
A secondary interface is to &quot;map&quot; the file into virtual pages, using the <code>mmap</code>
system call. The program can then use memory instructions directly on the file
data. Suppose file <code>foo</code> is <code>0x1000</code> bytes (4 kB, or one page) long. If <code>foo</code> is
mapped into memory starting at address <code>0x5000</code>, then any memory accesses to
locations <code>0x5000. . .0x5fff</code> will access the corresponding bytes of <code>foo</code>.</p>
<p>Here&apos;s a program that uses <code>mmap</code> to print a file to the console. It opens the
file specified on the command line, maps it at virtual address <code>0x10000000</code>,
writes the mapped data to the console (fd 1), and unmaps the file.</p>
<pre><code class="lang-C"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;syscall.h&gt;</span></span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> argc UNUSED, <span class="hljs-keyword">char</span> *argv[])</span>
</span>{
  <span class="hljs-keyword">void</span> *data = (<span class="hljs-keyword">void</span> *) <span class="hljs-number">0x10000000</span>;                 <span class="hljs-comment">/* Address at which to map. */</span>
  <span class="hljs-keyword">int</span> fd = open (argv[<span class="hljs-number">1</span>]);                          <span class="hljs-comment">/* Open file. */</span>
  <span class="hljs-keyword">void</span> *<span class="hljs-built_in">map</span> = mmap (data, filesize (fd), <span class="hljs-number">0</span>, fd, <span class="hljs-number">0</span>); <span class="hljs-comment">/* Map file. */</span>
  write (<span class="hljs-number">1</span>, data, filesize (fd));                   <span class="hljs-comment">/* Write file to console. */</span>
  munmap (<span class="hljs-built_in">map</span>);                                     <span class="hljs-comment">/* Unmap file (optional). */</span>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>Your submission must be able to track what memory is used by memory mapped
files. This is necessary to properly handle page faults in the mapped regions
and to ensure that mapped files do not overlap any other segments within the
process.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../project2/FAQ.html" class="navigation navigation-prev " aria-label="Previous page: FAQ">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="vm_management.html" class="navigation navigation-next " aria-label="Next page: Memory Management">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Introduction","level":"4.1","depth":1,"next":{"title":"Memory Management","level":"4.2","depth":1,"path":"project3/vm_management.md","ref":"project3/vm_management.md","articles":[]},"previous":{"title":"FAQ","level":"3.8","depth":1,"path":"project2/FAQ.md","ref":"project2/FAQ.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"project3/introduction.md","mtime":"2022-05-23T14:07:34.316Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-05-23T14:13:22.147Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

