
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Introduction Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="argument_passing.html" />
    
    
    <link rel="prev" href="../project1/FAQ.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Introduction</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../introduction/getting_started.html">
            
                <a href="../introduction/getting_started.html">
            
                    
                    Getting Started
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../introduction/grading.html">
            
                <a href="../introduction/grading.html">
            
                    
                    Grading
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../introduction/legal_and_ethical_issues.html">
            
                <a href="../introduction/legal_and_ethical_issues.html">
            
                    
                    Legal and Ethical Issues
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Project1: Threads</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../project1/introduction.html">
            
                <a href="../project1/introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../project1/alarm_clock.html">
            
                <a href="../project1/alarm_clock.html">
            
                    
                    Alarm Clock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../project1/priority_scheduling.html">
            
                <a href="../project1/priority_scheduling.html">
            
                    
                    Priority Scheduling
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../project1/advanced_scheduler.html">
            
                <a href="../project1/advanced_scheduler.html">
            
                    
                    Advanced Scheduler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../project1/FAQ.html">
            
                <a href="../project1/FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Project2: User Programs</li>
        
        
    
        <li class="chapter active" data-level="3.1" data-path="introduction.html">
            
                <a href="introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="argument_passing.html">
            
                <a href="argument_passing.html">
            
                    
                    Argument Passing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="user_memory.html">
            
                <a href="user_memory.html">
            
                    
                    User Memory
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="system_call.html">
            
                <a href="system_call.html">
            
                    
                    System Calls
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="process_termination.html">
            
                <a href="process_termination.html">
            
                    
                    Process Termination Messages
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="deny_write.html">
            
                <a href="deny_write.html">
            
                    
                    Denying Writes to Executables
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.7" data-path="dup.html">
            
                <a href="dup.html">
            
                    
                    Extend File Descriptor (Extra)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.8" data-path="FAQ.html">
            
                <a href="FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Project3: Virtual Memory</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../project3/introduction.html">
            
                <a href="../project3/introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../project3/vm_management.html">
            
                <a href="../project3/vm_management.html">
            
                    
                    Memory Management
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../project3/anon.html">
            
                <a href="../project3/anon.html">
            
                    
                    Anonymous Page
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="../project3/stack_growth.html">
            
                <a href="../project3/stack_growth.html">
            
                    
                    Stack Growth
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="../project3/memory_mapped_files.html">
            
                <a href="../project3/memory_mapped_files.html">
            
                    
                    Memory Mapped Files
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="../project3/swapping.html">
            
                <a href="../project3/swapping.html">
            
                    
                    Swap In/Out
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="../project3/cow.html">
            
                <a href="../project3/cow.html">
            
                    
                    Copy-on-Write (Extra)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.8" data-path="../project3/FAQ.html">
            
                <a href="../project3/FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Project4: File System</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../project4/introduction.html">
            
                <a href="../project4/introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../project4/indexed_and_extensible_files.html">
            
                <a href="../project4/indexed_and_extensible_files.html">
            
                    
                    Indexed and Extensible Files
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="../project4/subdirectories.html">
            
                <a href="../project4/subdirectories.html">
            
                    
                    Subdirectories and Soft Links
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="../project4/buffer_cache.html">
            
                <a href="../project4/buffer_cache.html">
            
                    
                    Buffer Cache (Extra)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="../project4/synchronization.html">
            
                <a href="../project4/synchronization.html">
            
                    
                    Synchronization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.6" data-path="../project4/FAQ.html">
            
                <a href="../project4/FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Appendix</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../appendix/threads.html">
            
                <a href="../appendix/threads.html">
            
                    
                    Threads
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="../appendix/synchronization.html">
            
                <a href="../appendix/synchronization.html">
            
                    
                    Synchronization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="../appendix/memory_allocation.html">
            
                <a href="../appendix/memory_allocation.html">
            
                    
                    Memory Allocation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.4" data-path="../appendix/virtual_address.html">
            
                <a href="../appendix/virtual_address.html">
            
                    
                    Virtual Address
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.5" data-path="../appendix/page_table.html">
            
                <a href="../appendix/page_table.html">
            
                    
                    Page Table
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.6" data-path="../appendix/debugging_tools.html">
            
                <a href="../appendix/debugging_tools.html">
            
                    
                    Debugging Tools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.7" data-path="../appendix/development_tools.html">
            
                <a href="../appendix/development_tools.html">
            
                    
                    Development Tools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.8" data-path="../appendix/hash_table.html">
            
                <a href="../appendix/hash_table.html">
            
                    
                    Hash Table
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Introduction</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="project2-user-programs">Project2: User Programs</h1>
<p>Now that you&apos;ve worked with Pintos and are becoming familiar with its
infrastructure and thread package, it&apos;s time to start working on the parts of
the system that allow running user programs. The base code already supports
loading and running user programs, but no I/O or interactivity is possible. In
this project, you will enable programs to interact with the OS via system calls.
You will be working out of the <code>userprog</code> directory for this assignment, but you
will also be interacting with almost every other part of Pintos. We will
describe the relevant parts below.</p>
<p><strong>You must build project 2 on top of your project 1 submission.</strong> Although no
code from project 1 affects code for project 2, you still have to pass test
cases for project 1 because this is an incremental project.</p>
<p>Also, please notify there is extra challenge from project2. <strong>This is just an
optional implementation.</strong> Also, for the extra challenge, there isn&apos;t any
skeleton code for you except the test cases. All designs are up to you.
<strong>To submit and test your extra requirements, you will need to edit
<code>userprog/Make.vars</code></strong>.</p>
<p>Lastly, please note that the code without <code>TODO</code> does not always you don&apos;t need
to change that code. You can freely modify any source codes in project2, except
the testing codes.</p>
<h2 id="background">Background</h2>
<p>Up to now, all of the code you have run under Pintos has been part of the
operating system kernel. This means, for example, that all the test code from
the last assignment ran as part of the kernel, with full access to privileged
parts of the system. Once we start running user programs on top of the operating
system, this is no longer true. This project deals with the consequences.</p>
<p>We allow more than one process to run at a time. Each process has one thread
(multithreaded processes are not supported). User programs are written under the
illusion that they have the entire machine. This means that when you load and
run multiple processes at a time, you must manage memory, scheduling, and other
state correctly to maintain this illusion.</p>
<p>In the previous project, we compiled our test code directly into your kernel,
so we had to require certain specific function interfaces within the kernel.
From now on, we will test your operating system by running user programs. This
gives you much greater freedom. You must make sure that the user program
interface meets the specifications described here, but given that constraint you
are free to restructure or rewrite kernel code however you wish. All of your
codes should never located in block that enclosed by <code>#ifdef VM</code>. This blocks
will be included after enabling the virtual memory subsystem, which you will
implement in the project 3. Also, if the codes is enclosed by <code>#ifndef VM</code>,
those codes will be omitted from project3.</p>
<p><strong>We strongly recommend you to read
<a href="../appendix/synchronization.html">synchronization</a> and <a href="../appendix/virtual_address.html">virtual
addrees</a> before you start.</strong></p>
<h3 id="source-files">Source Files</h3>
<p>The easiest way to get an overview of the programming you will be doing is to
simply go over each part you&apos;ll be working with. In <code>userprog</code>, you&apos;ll find a
small number of files, but here is where the bulk of your work will be:</p>
<ul>
<li><p><code>process.c</code>, <code>process.h</code></p>
<p>Loads ELF binaries and starts processes.</p>
</li>
<li><p><code>syscall.c</code>, <code>syscall.h</code></p>
<p>Whenever a user process wants to access some kernel functionality, it invokes
a system call. This is a skeleton system call handler. Currently, it just
prints a message and terminates the user process. In part 2 of this project
you will add code to do everything else needed by system calls.</p>
</li>
<li><p><code>syscall-entry.S</code></p>
<p>Small assembly codes that bootstrap the system call handler. You
don&apos;t need to understand this code.</p>
</li>
<li><p><code>exception.c</code>, <code>exception.h</code></p>
<p>When a user process performs a privileged or prohibited operation, it traps
into the kernel as an <code>exception</code> or <code>fault</code>. These files handle exceptions.
Currently all exceptions simply print a message and terminate the process.
Some, but not all, solutions to project 2 require modifying <code>page_fault()</code> in
this file.</p>
</li>
</ul>
<ul>
<li><p><code>gdt.c</code>, <code>gdt.h</code></p>
<p>The x86-64 is a segmented architecture. The Global Descriptor Table (GDT)
is a table that describes the segments in use. These files set up the GDT.
You should not need to modify these files for any of the projects. You can
read the code if you&apos;re interested in how the GDT works.</p>
</li>
<li><p><code>tss.c</code>, <code>tss.h</code></p>
<p>The Task-State Segment (TSS) was used for x86 architectural task switching.
However, in x86-64, task switching is deprecated. Nontheless, TSS is still
there to find the stack pointer during the ring switching.</p>
<p>This means when a user process enters an interrupt handler, the hardware
consults to the tss to look up the kernel&apos;s stack pointer. You should not need
to modify these files for any of the pojects. You can read the code if you&apos;re
interested in how the TSS works.</p>
</li>
</ul>
<h3 id="using-the-file-system">Using the File System</h3>
<p>You will need to interface to the file system code for this project, because
user programs are loaded from the file system and many of the system calls you
must implement deal with the file system. However, the focus of this project is
not the file system, so we have provided a simple but complete file system in
the <code>filesys</code> directory. You will want to look over the <code>filesys.h</code> and <code>file.h</code>
interfaces to understand how to use the file system, and especially its many
limitations.</p>
<p><strong>There is no need to modify the file system code for this project</strong>, and so we
recommend that you do not. Working on the file system is likely to distract you
from this project&apos;s focus.</p>
<p><strong>Proper use of the file system routines now will make life much easier for
project 4</strong>, when you improve the file system implementation. Until then, you
will have to tolerate the following limitations:</p>
<ul>
<li>No internal synchronization. Concurrent accesses will interfere with one
another. You should use synchronization to ensure that only one process at a
time is executing file system code.</li>
<li>File size is fixed at creation time. The root directory is represented as a
file, so the number of files that may be created is also limited.</li>
<li>File data is allocated as a single extent, that is, data in a single file must
occupy a contiguous range of sectors on disk. External fragmentation can
therefore become a serious problem as a file system is used over time.</li>
<li>No subdirectories</li>
<li>File names are limited to 14 characters.</li>
<li>A system crash mid-operation may corrupt the disk in a way that cannot be
repaired automatically. There is no file system repair tool anyway.</li>
</ul>
<p><strong>One important feature is included:</strong></p>
<p>Unix-like semantics for <code>filesys_remove()</code> are implemented. That is, if a file
is open when it is removed, its blocks are not deallocated and it may still be
accessed by any threads that have it open, until the last one closes it. See
<a href="FAQ.html">Removing an Open File</a> for more information.</p>
<hr>
<p>Unlike project 1 where all test programs were already present in the kernel image,
you have to put test programs (which runs in the user space) into the Pintos
virtual machine. To make your life much easier, our testing scripts
(i.e. <code>make check</code>) automatically handle this, so in most cases, you don&apos;t need
to understand this. However, knowing this would significantly help you to run
individual test cases.</p>
<p>To put a file into the Pintos virtual machine, firstly you need to be able to
create a simulated disk with a file system partition. The
<code>pintos-mkdisk</code> program provides this functionality. From the <code>userprog/build</code>
directory, execute <code>pintos-mkdisk filesys.dsk 2</code>. This command
creates a simulated disk named <code>filesys.dsk</code> that contains a 2 MB Pintos file
system partition. Then, specify the disk by passing <code>--fs-disk filesys.dsk</code>
after <code>pintos</code> but before <code>--</code> (i.e. <code>pintos --fs-disk filesys.disk -- KERNEL_COMMANDS...</code>).
The <code>--</code> is needed because <code>--fs-disk</code> is for the pintos script, not for
the simulated kernel. Afterward, format the file system partition by passing
<code>-f -q</code> on the kernel&apos;s command line: <code>pintos SCRIPT_COMMANDS -- -f -q</code>. The <code>-f</code>
option causes the file system to be formatted, and <code>-q</code> causes Pintos to exit
as soon as the format is done.</p>
<p>You&apos;ll need a way to copy files in and out of the simulated file system. The
pintos <code>-p</code> (&quot;put&quot;) and <code>-g</code> (&quot;get&quot;) options do this. To copy &apos;file&apos; into the
Pintos file system, use the command <code>pintos -p file -- -q</code>. To copy it
to the Pintos file system under the name <code>newname</code>, add <code>:newname</code> after the
original filename: <code>pintos -p file:newname -- -q</code>. The commands for copying
files out of a VM are similar, but substitute <code>-g</code> for <code>-p</code>.</p>
<p>Incidentally, these commands work by passing special commands extract and append
on the kernel&apos;s command line and copying to and from a special simulated
&quot;scratch&quot; partition. If you&apos;re very curious, you can look at the pintos script
as well as <code>filesys/fsutil.c</code> to learn the implementation details.</p>
<p>Here&apos;s a summary of how to create a disk with a file system partition, format
the file system, copy the <em>args-single</em> program&#x2014;which is the second test case for
this project&#x2014;into the new disk, and then run it, passing argument &apos;onearg&apos;.
(Argument passing won&apos;t work until you implemented it.) It assumes that you&apos;ve
already built the test cases and that the current directory is <code>userprog/build</code>:</p>
<pre><code class="lang-sh">pintos-mkdisk filesys.dsk 10
pintos --fs-disk filesys.dsk -p tests/userprog/args-single:args-single -- -q <span class="hljs-_">-f</span> run <span class="hljs-string">&apos;args-single onearg&apos;</span>
</code></pre>
<p>If you don&apos;t want to keep the file system disk around for later use or
inspection, you can even combine all four steps into a single command.
The <code>--filesys-size=n</code> option creates a temporary file system partition
approximately n megabytes in size just for the duration of the pintos run.
The Pintos automatic test suite makes extensive use of this syntax:</p>
<pre><code class="lang-sh">pintos --fs-disk=10 -p tests/userprog/args-single:args-single -- -q <span class="hljs-_">-f</span> run <span class="hljs-string">&apos;args-single onearg&apos;</span>
</code></pre>
<h3 id="how-user-programs-work">How User Programs Work</h3>
<p>Pintos can run normal C programs, as long as they fit into memory and use only
the system calls you implement. Notably, <code>malloc()</code> cannot be implemented
because none of the system calls required for this project allow for memory
allocation. Pintos also can&apos;t run programs that use floating point operations,
since the kernel doesn&apos;t save and restore the processor&apos;s floating-point unit
when switching threads.</p>
<p>Pintos can load ELF executables with the loader provided for you in
<code>userprog/process.c</code>. ELF is a file format used by Linux, Solaris, and many
other operating systems for object files, shared libraries, and executables.</p>
<p>You can actually use any compiler and linker that output x86-64 ELF executables
to produce programs for Pintos. (We&apos;ve provided compilers and linkers that
should do just fine.) You should realize immediately that, until you copy a test
program to the simulated file system, Pintos will be unable to do useful work.
You won&apos;t be able to do interesting things until you copy a variety of programs
to the file system. You might want to create a clean reference file system disk
and copy that over whenever you trash your <code>filesys.dsk</code> beyond a useful state,
which may happen occasionally while debugging.</p>
<h3 id="virtual-memory-layout">Virtual Memory Layout</h3>
<p>Virtual memory in Pintos is divided into two regions: user virtual memory and
kernel virtual memory. User virtual memory ranges from virtual address <code>0</code> up to
<code>KERN_BASE</code>, which is defined in <code>include/threads/vaddr.h</code> and defaults to
<code>0x8004000000</code> Kernel virtual memory occupies the rest of the virtual address
space.</p>
<p>User virtual memory is per-process. When the kernel switches from one process to
another, it also switches user virtual address spaces by changing the
processor&apos;s page directory base register (see <code>pml4_activate()</code> in
<code>thread/mmu.c</code>). struct thread contains a pointer to a process&apos;s page table.</p>
<p>Kernel virtual memory is global. It is always mapped the same way, regardless
of what user process or kernel thread is running. In Pintos, kernel virtual
memory is mapped one-to-one to physical memory, starting at <code>KERN_BASE</code>. That
is, virtual address <code>KERN_BASE</code> accesses physical address <code>0</code>, virtual address
<code>KERN_BASE + 0x1234</code> accesses physical address <code>0x1234</code>, and so on up to the
size of the machine&apos;s physical memory.</p>
<p>A user program can only access its own user virtual memory. An attempt to access
kernel virtual memory causes a page fault, handled by <code>page_fault()</code> in
<code>userprog/exception.c</code>, and the process will be terminated. Kernel threads can
access both kernel virtual memory and, if a user process is running, the user
virtual memory of the running process. However, even in the kernel, an attempt
to access memory at an unmapped user virtual address will cause a page fault.</p>
<h3 id="typical-memory-layout">Typical Memory Layout</h3>
<p>Conceptually, each process is free to lay out its own user virtual memory
however it chooses. In practice, user virtual memory is laid out like this:</p>
<pre><code>USER_STACK +----------------------------------+
           |             user stack           |
           |                 |                |
           |                 |                |
           |                 V                |
           |           grows downward         |
           |                                  |
           |                                  |
           |                                  |
           |                                  |
           |           grows upward           |
           |                 ^                |
           |                 |                |
           |                 |                |
           +----------------------------------+
           | uninitialized data segment (BSS) |
           +----------------------------------+
           |     initialized data segment     |
           +----------------------------------+
           |            code segment          |
 0x400000  +----------------------------------+
           |                                  |
           |                                  |
           |                                  |
           |                                  |
           |                                  |
       0   +----------------------------------+
</code></pre><p>In this project, the user stack is fixed in size, but in project 3 it will be
allowed to grow. Traditionally, the size of the uninitialized data segment can
be adjusted with a system call, but you will not have to implement this.</p>
<p>The code segment in Pintos starts at user virtual address 0x400000,
approximately 128 MB from the bottom of the address space. This value was
typical value in ubuntu and has no deep significance.</p>
<p>The linker sets the layout of a user program in memory, as directed by a &quot;linker
script&quot; that tells it the names and locations of the various program segments.
You can learn more about linker scripts by reading the &quot;Scripts&quot; chapter in the
linker manual, accessible via <code>info ld</code>.</p>
<p>To view the layout of a particular executable, run objdump with the <code>-p</code> option.</p>
<h3 id="accessing-user-memory">Accessing User Memory</h3>
<p>As part of a system call, the kernel must often access memory through pointers
provided by a user program. The kernel must be very careful about doing so,
because the user can pass a null pointer, a pointer to unmapped virtual memory,
or a pointer to kernel virtual address space (above <code>KERN_BASE</code>). All of these
types of invalid pointers must be rejected without harm to the kernel or other
running processes, by terminating the offending process and freeing its
resources.</p>
<p>There are at least two reasonable ways to do this correctly. The first method is
to verify the validity of a user-provided pointer, then dereference it. If you
choose this route, you&apos;ll want to look at the functions in <code>thread/mmu.c</code>
and in <code>include/threads/vaddr.h</code>. This is the simplest way to handle user
memory access.</p>
<p>The second method is to check only that a user pointer points below <code>KERN_BASE</code>,
then dereference it. An invalid user pointer will cause a &quot;page fault&quot; that you
can handle by modifying the code for <code>page_fault()</code> in <code>userprog/exception.c</code>.
This technique is normally faster because it takes advantage of the processor&apos;s
MMU, so it tends to be used in real kernels (including Linux).</p>
<p>In either case, you need to make sure not to &quot;leak&quot; resources. For example,
suppose that your system call has acquired a lock or allocated memory with
<code>malloc()</code>. If you encounter an invalid user pointer afterward, you must still
be sure to release the lock or free the page of memory. If you choose to verify
user pointers before dereferencing them, this should be straightforward. It&apos;s
more difficult to handle if an invalid pointer causes a page fault, because
there&apos;s no way to return an error code from a memory access. Therefore, for
those who want to try the latter technique, we&apos;ll provide a little bit of
helpful code:</p>
<pre><code class="lang-C"><span class="hljs-comment">/* Reads a byte at user virtual address UADDR.
 * UADDR must be below KERN_BASE.
 * Returns the byte value if successful, -1 if a segfault
 * occurred. */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> int64_t
<span class="hljs-title">get_user</span> <span class="hljs-params">(<span class="hljs-keyword">const</span> uint8_t *uaddr)</span> </span>{
    <span class="hljs-keyword">int64_t</span> result;
    __asm __volatile (
    <span class="hljs-string">&quot;movabsq $done_get, %0\n&quot;</span>
    <span class="hljs-string">&quot;movzbq %1, %0\n&quot;</span>
    <span class="hljs-string">&quot;done_get:\n&quot;</span>
    : <span class="hljs-string">&quot;=&amp;a&quot;</span> (result) : <span class="hljs-string">&quot;m&quot;</span> (*uaddr));
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">/* Writes BYTE to user address UDST.
 * UDST must be below KERN_BASE.
 * Returns true if successful, false if a segfault occurred. */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span>
<span class="hljs-title">put_user</span> <span class="hljs-params">(uint8_t *udst, uint8_t byte)</span> </span>{
    <span class="hljs-keyword">int64_t</span> error_code;
    __asm __volatile (
    <span class="hljs-string">&quot;movabsq $done_put, %0\n&quot;</span>
    <span class="hljs-string">&quot;movb %b2, %1\n&quot;</span>
    <span class="hljs-string">&quot;done_put:\n&quot;</span>
    : <span class="hljs-string">&quot;=&amp;a&quot;</span> (error_code), <span class="hljs-string">&quot;=m&quot;</span> (*udst) : <span class="hljs-string">&quot;q&quot;</span> (byte));
    <span class="hljs-keyword">return</span> error_code != <span class="hljs-number">-1</span>;
}
</code></pre>
<p>Each of these functions assumes that the user address has already been verified
to be below <code>KERN_BASE</code>. They also assume that you&apos;ve modified <code>page_fault()</code> so
that a page fault in the kernel merely sets rax to -1 and copies its former
value into <code>%rip</code>.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../project1/FAQ.html" class="navigation navigation-prev " aria-label="Previous page: FAQ">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="argument_passing.html" class="navigation navigation-next " aria-label="Next page: Argument Passing">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Introduction","level":"3.1","depth":1,"next":{"title":"Argument Passing","level":"3.2","depth":1,"path":"project2/argument_passing.md","ref":"project2/argument_passing.md","articles":[]},"previous":{"title":"FAQ","level":"2.5","depth":1,"path":"project1/FAQ.md","ref":"project1/FAQ.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"project2/introduction.md","mtime":"2022-05-23T14:07:34.344Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-05-23T14:13:22.147Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

